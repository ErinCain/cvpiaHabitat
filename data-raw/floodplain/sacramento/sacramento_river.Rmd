---
title: "Sacramento"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com)"
date: "July 2, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%')
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(tidyverse)
library(readxl)
library(cvpiaHabitat)
```

## Modeling Details
**Data Source:**
Central Valley Floodplain Evaluation and Delineation (CVFED) HEC-RAS hydraulic model refined for use in the [NOAA-NMFS Winter Run Chinook Salmon life cycle model](https://s3-us-west-2.amazonaws.com/cvpiahabitat-r-package/cvpia-sit-model-inputs/HendrixEtAl2014_Winter_Run_Model_Tech_Memo.pdf)

High quality habitat defined by:

* Channel depth > 0.2 m and < 1.5 m
* Velocity <= 0.15 m/s

The habitat areas are already suitable, don't scale down.

NOAA NMFS Winter Run Chinnok Salmon Life Cycle Model Segments:

* Section 1 - Keswick to Battle Creek (28.92 mi)
* Section 2 - Battle Creek to Feather River (186.50 mi)
* Section 3 - Feather River to Freeport (33.90 mi)

CVPIA Sacramento Rearing Segments:

* Upper Sacramento River - Keswick to Red Bluff (59.28 mi) falls within Section 1 and Section 2 of NOAA NMFS modeling
* Upper-mid Sacramento River - Red Bluff to Wilkins Slough (122.25 mi) falls within Section 2 of NOAA NMFS modeling)
* Lower-mid Sacramento River - Wilkins Slough to American (57.96 mi) falls within Section 2 and Section 3 of NOAA NMFS modeling)
* Lower Sacramento River - American to Freeport (13.70 mi) falls within Section 3 of NOAA NMFS modeling

```{r}
# sac <- read_csv('data-raw/floodplain/sacramento/sacramento_floodplain.csv')

sac_floodplain <- read_csv(file = 'cvpiaHabitat/data-raw/watershed/sacramento/data/sacramento_floodplain.csv',
                           col_names = c('flow_cfs', 'kes_bat', 'bat_feat', 'feat_free'), skip = 1) %>%
  gather(reach, sq_ft, -flow_cfs) %>%
  mutate(sq_meters = sq_ft * 0.092903)

# NOAA study reaches
kes_bat_mi <- 295.92 - 267 #keswick to battle
bat_feat_mi <- 267 - 80.5 # battle to feather
feat_free_mi <- 80.5 - 46.6 # feather to freeport

# linear interpolation functions for each study reach --------------
kes_bat <- sac_floodplain %>%
  filter(reach == 'kes_bat')

bat_feat <- sac_floodplain %>%
  filter(reach == 'bat_feat')

feat_free <- sac_floodplain %>%
  filter(reach == 'feat_free')

# look up vector for converting study reach areas into area per miles--------------
reach_miles <- c(kes_bat_mi, bat_feat_mi, feat_free_mi)
names(reach_miles) <- c('kes_bat', 'bat_feat', 'feat_free')
```

## Upper Sacramento River

The CVPIA Upper Sacramento River reach is 59.28 miles, 28.92 of those miles are in the NOAA NMFS study's first reach and the rest are in the second reach. We have summed the propotion of area by length in second reach to total in first. 

```{r}
upper_sac_above_battle <- 28.92
upper_sac_below_battle <- 59.28 - upper_sac_above_battle
prop_bat_rbdd <- upper_sac_below_battle / reach_miles['bat_feat']

upper_sac_fp <- bat_feat %>%
  mutate(sq_meter_scaled = sq_meters * prop_bat_rbdd) %>%
  bind_cols(kes_bat) %>%
  mutate(floodplain_sq_meters = sq_meter_scaled + sq_meters1,
         watershed = 'Upper Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- upper_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

upper_sacramento_river_floodplain <- upper_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(upper_sacramento_river_floodplain, 5))

# devtools::use_data(upper_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 73 more rows*

```{r, out.width = '90%'}
upper_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres',  title = 'Upper Sacramento River Floodplain Habitat')
```

## Upper-mid Sacramento River 

The CVPIA Upper-mid Sacramento River reach is 122.25 miles, all contained with in the NOAA NMFS study's second reach.
```{r}
rbdd_wilk_mi <- 122.25
prop_rbdd_wilkins <- rbdd_wilk_mi / reach_miles['bat_feat']

upper_mid_sac_fp <- bat_feat %>%
  mutate(floodplain_sq_meters = sq_meters * prop_rbdd_wilkins,
         watershed = 'Upper-mid Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- upper_mid_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

upper_mid_sacramento_river_floodplain <- upper_mid_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(upper_mid_sacramento_river_floodplain, 5))

# devtools::use_data(upper_mid_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 73 more rows*

```{r, out.width = '90%'}
upper_mid_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres',  title = 'Upper-mid Sacramento River Floodplain Habitat')
```

## Lower-mid Sacramento River 

The CVPIA Lower-mid Sacramento River reach is 57.96 miles, 33.89 of those miles are in the NOAA NMFS study's second reach and the rest are in the third reach. We have summed the propotion of area by length in second reach to total in first. 
```{r}
wilk_amer_mi <- 57.96
wilk_feather_mi <- reach_miles['bat_feat'] - rbdd_wilk_mi - upper_sac_below_battle
prop_wilkins_feather <- wilk_feather_mi / reach_miles['bat_feat']
feat_amer_mi <- wilk_amer_mi - wilk_feather_mi
prop_feat_amer <- feat_amer_mi/reach_miles['feat_free']

lower_mid_sac_fp<- bat_feat %>%
  bind_cols(feat_free) %>%
  mutate(sq_meter_scaled1 = sq_meters * prop_wilkins_feather,
         sq_meter_scaled2 = sq_meters1 * prop_feat_amer) %>%
  mutate(floodplain_sq_meters = sq_meter_scaled1 + sq_meter_scaled2,
         watershed = 'Lower-mid Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- lower_mid_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

lower_mid_sacramento_river_floodplain <- lower_mid_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(lower_mid_sacramento_river_floodplain, 5))
# devtools::use_data(lower_mid_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 73 more rows*

```{r, out.width = '90%'}
lower_mid_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres', title = 'Lower-mid Sacramento River Floodplain Habitat')
```

## Lower Sacramento River
The CVPIA Lower Sacramento River reach is 13.70 miles, all contained with in the NOAA NMFS study's third reach.
```{r}
amer_free_mi <- reach_miles['feat_free'] - feat_amer_mi
prop_amer_free <- amer_free_mi / reach_miles['feat_free']

lower_sac_fp <- feat_free %>%
  mutate(floodplain_sq_meters = sq_meters * prop_amer_free,
         watershed = 'Lower Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- lower_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

lower_sacramento_river_floodplain <- lower_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(lower_sacramento_river_floodplain, 5))
# devtools::use_data(lower_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 25 more rows*

```{r, out.width = '90%'}
lower_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres', title = 'Lower Sacramento River Floodplain Habitat')
```
