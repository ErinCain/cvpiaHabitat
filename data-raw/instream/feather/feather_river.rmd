---
title: "Feather River"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com)"
date: "December 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(tidyverse)
library(readxl)
library(cvpiaHabitat)
library(scales)
```

## Future Data Improvements

## Instream Spawning and Rearing Habitat

> **Data Source:** [California Department of Water Resources](https://s3-us-west-2.amazonaws.com/cvpiahabitat-r-package/cvpia-sit-model-inputs/Feather_FERC_IFIM_Phase_2.pdf) and [Thomas R. Payne & Associates](https://s3-us-west-2.amazonaws.com/cvpiahabitat-r-package/cvpia-sit-model-inputs/Payne2002_FeatherRiverIFIM+7-22-02.pdf

## Rearing Raw Data
Describe data TODO
Mark Gard instructed us to use A1:D8 of the 'Feather' tab within his 'IFIMWUA.xlsx' 

The data units are flow in cfs, WUA in square feet per 1000 feet.

```{r}
feather_raw <- read_excel('data-raw/mark_gard_data/IFIMWUA.xlsx', range = "A1:D8", sheet = 'Feather')
feather_raw
```

## Spawning WUA
We noticed that more data was avaliable for spawning and went to the FERC 2004 report and hand digitized the spawning relationship using <https://automeris.io/WebPlotDigitizer/>


The modeling was broken into lower and upper we used linear exptrapolation to have
wua value at unique set of flow values for the two models. We scaled the modeling by length
TODO


```{r}
upper <- read_csv('data-raw/instream/feather/alt_upper_feather_spawn_wua_rsi.csv') %>%
  mutate(location = 'upper')

lower <- read_csv('data-raw/instream/feather/alt_lower_feather_spawn_wua_rsi.csv') %>%
  mutate(location = 'lower')

upper_approx <- approxfun(upper$flow, upper$wua_rsi, rule = 2)
lower_approx <- approxfun(lower$flow, lower$wua_rsi, rule = 2)

spawning <- tibble(
  flow_cfs = c(200, 500, 750, 1000, 1250, 1500, 1750, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000, 6500, 7000),
  upper_wua = upper_approx(flow_cfs),
  lower_wua = lower_approx(flow_cfs)) %>%
  mutate(FR_spawn_wua = upper_wua * (9.75/18) + lower_wua * (8.25/18)) %>%
  select(flow_cfs, FR_spawn_wua)

```

### Spawning WUA Plot

```{r, echo=FALSE}
spawning %>% 
  ggplot(aes(flow_cfs, FR_spawn_wua)) +
  geom_point() +
  labs(x = 'flow (cfs)', y = 'spawning WUA (sqft/1000ft)') +
  scale_y_continuous(labels = comma)
```

### Rearing WUA Plot
```{r, echo=FALSE}
feather_raw %>%
  filter(!is.na(`Fry Rearing`)) %>%
  select(-Spawning) %>%
  gather(species, wua, - Flow) %>%
  ggplot(aes(Flow, wua, color = species)) +
  geom_line() +
  labs(x = 'flow (cfs)', y = 'spawning WUA (sqft/1000ft)') +
  scale_y_continuous(labels = comma)
```


## Combine Spawning and Rearing Data
Prepare data in proper form to be used in habitat setting functions.

```{r}
feather_river_instream <- feather_raw %>% 
  select(-Spawning) %>% 
  rename(flow_cfs = Flow, FR_fry_wua = `Fry Rearing`, FR_juv_wua = `Juv Rearing`) %>% 
  full_join(spawning) %>% 
  arrange(flow_cfs) %>% 
  mutate(watershed = 'Feather River') %>%
  select(flow_cfs,
         FR_spawn_wua,
         FR_fry_wua,
         FR_juv_wua,
         watershed)
  
# devtools::use_data(feather_river_instream, overwrite = TRUE)
```
