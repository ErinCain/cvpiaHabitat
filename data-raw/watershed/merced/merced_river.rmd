---
title: "Merced River"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com), [Erin Cain](ecain@flowwest.com)"
date: "June 16, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(tidyverse)
library(readxl)
library(cvpiaHabitat)
```
## Future Data Improvements
None planned
 
## Instream Spawning and Rearing Habitat

**Data Source:**
[Merced Irrigation District 2013](https://cvpiahabitat-r-package.s3-us-west-2.amazonaws.com/cvpia-sit-model-inputs/MID2013_MercedIFIMStudy.pdf) (pg 67-75)

Instream spawning and rearing habitat for Fall Run Chinook Salmon and Steelhead in the Merced River is based on data from a 2011 and 2012 Merced Irrigation District (Merced ID) flow-habitat study in the 19.2 mile-long section of the Merced River from Crocker-Huffman Diversion Dam at river mile (RM) 52.01 downstream to Shaffer Bridge at RM 32.8. Habitat data from this study is summarized on pages 67 - 75 of the MID 2013 study. The instream spawning and rearing habitat data was provided to us by [Mark Gard](mailto:mark_gard@fws.gov) from the U.S. Fish and Wildlife Service in a spreadsheet (see '~/cvpiaHabitat/data-raw/mark_gard_data/IFIMWUA.xlsx') that creates an average of the WUA values for the three study reaches weighted by the length of each study reach. Mark Gard instructed us to use A18:E48 of the 'Merced' tab within his 'IFIMWUA.xlsx'.

### Combine Spawning and Rearing Data
The instream spawning and rearing habitat data described above for Fall Run Chinook Salmon (FR) and Steelhead (ST) is combined for use in the DSM in the following format. Units are in square feet per 1000 feet.


```{r,echo=FALSE}
reach_miles <- c(9.2, 4.4, 5.6)
names(reach_miles) <- 1:3

# fall run data
fr_reach_1 <- read_excel('data-raw/mark_gard_data/IFIMWUA.xlsx', 
                         range = "A51:D81", sheet = 'Merced') %>% 
  mutate(reach = 1, miles = reach_miles[reach]) %>% 
  rename(flow_cfs = Flow, spawn = Spawning, fry = `Fry Rearing`, 
         juv = `Juv Rearing`) 

fr_reach_2 <- read_excel('data-raw/mark_gard_data/IFIMWUA.xlsx', 
                         range = "A84:D114", sheet = 'Merced') %>% 
  mutate(reach = 2, miles = reach_miles[reach]) %>% 
  rename(flow_cfs = Flow, spawn = Spawning, fry = `Fry Rearing`, 
         juv = `Juv Rearing`) 

fr_reach_3 <- read_excel('data-raw/mark_gard_data/IFIMWUA.xlsx', 
                         range = "A117:D147", sheet = 'Merced') %>% 
  mutate(reach = 3, miles = reach_miles[reach]) %>% 
  rename(flow_cfs = Flow, spawn = Spawning, fry = `Fry Rearing`, 
         juv = `Juv Rearing`) 

fr <- bind_rows(fr_reach_1, fr_reach_2, fr_reach_3) %>% 
  gather(life_stage, wua, -flow_cfs, -reach, -miles) %>% 
  mutate(species = 'FR')

make_approx_funs <- function(df) {
  
  flow <- df$flow_cfs
  spawn <- approxfun(flow, df$spawn, rule = 2)
  fry <- approxfun(flow, df$fry, rule = 2)
  juv <- approxfun(flow, df$juv, rule = 2)
  
  result <- list(spawn = spawn, fry = fry, juv = juv)

  if ('adult' %in% names(df)) {
    adult <- approxfun(flow, df$adult, rule = 2)
    result$adult = adult
  }
  
  return(result)
}

fr_approx_1 <- make_approx_funs(fr_reach_1)
fr_approx_2 <- make_approx_funs(fr_reach_2)
fr_approx_3 <- make_approx_funs(fr_reach_3)

# steelhead data
st <- read_csv('data-raw/watershed/merced/data/merced_steelhead.csv', 
               skip = 1) %>% 
  rename(spawn = ST_spawn_wua, fry = ST_fry_wua, juv = ST_juv_wua, 
         adult = ST_adult_wua) %>% 
  gather(life_stage, wua, -flow_cfs, -reach, -miles) %>% 
  mutate(species = 'ST')

st_reach_1 <- st %>% 
  filter(reach == 1) %>% 
  select(flow_cfs, life_stage, wua) %>% 
  spread(life_stage, wua)

st_reach_2 <- st %>% 
  filter(reach == 2) %>% 
  select(flow_cfs, life_stage, wua) %>% 
  spread(life_stage, wua)

st_reach_3 <- st %>% 
  filter(reach == 3) %>% 
  select(flow_cfs, life_stage, wua) %>% 
  spread(life_stage, wua)

st_approx_1 <- make_approx_funs(st_reach_1)
st_approx_2 <- make_approx_funs(st_reach_2)
st_approx_3 <- make_approx_funs(st_reach_3)

total <- sum(reach_miles)

flows <- bind_rows(fr, st) %>% 
  pull(flow_cfs) %>% 
  unique() %>% 
  sort()

# combine reaches weighted by length

merced_river_instream <- tibble(
  flow_cfs = flows,
  FR_spawn_wua = 
    fr_approx_1$spawn(flow_cfs) * reach_miles[1] / total + 
    fr_approx_2$spawn(flow_cfs) * reach_miles[2] / total + 
    fr_approx_3$spawn(flow_cfs) * reach_miles[3] / total,
  FR_fry_wua = 
    fr_approx_1$fry(flow_cfs) * reach_miles[1] / total +
    fr_approx_2$fry(flow_cfs) * reach_miles[2] / total +
    fr_approx_3$fry(flow_cfs) * reach_miles[3] / total,
  FR_juv_wua = 
    fr_approx_1$juv(flow_cfs) * reach_miles[1] / total +
    fr_approx_2$juv(flow_cfs) * reach_miles[2] / total +
    fr_approx_3$juv(flow_cfs) * reach_miles[3] / total,
  ST_spawn_wua =
    st_approx_1$spawn(flow_cfs) * reach_miles[1] / total + 
    st_approx_2$spawn(flow_cfs) * reach_miles[2] / total + 
    st_approx_3$spawn(flow_cfs) * reach_miles[3] / total,
  ST_fry_wua =
    st_approx_1$fry(flow_cfs) * reach_miles[1] / total + 
    st_approx_2$fry(flow_cfs) * reach_miles[2] / total + 
    st_approx_3$fry(flow_cfs) * reach_miles[3] / total,
  ST_juv_wua =
    st_approx_1$juv(flow_cfs) * reach_miles[1] / total + 
    st_approx_2$juv(flow_cfs) * reach_miles[2] / total + 
    st_approx_3$juv(flow_cfs) * reach_miles[3] / total,
  ST_adult_wua =
    st_approx_1$adult(flow_cfs) * reach_miles[1] / total + 
    st_approx_2$adult(flow_cfs) * reach_miles[2] / total + 
    st_approx_3$adult(flow_cfs) * reach_miles[3] / total,
  watershed = 'Merced River'
)

knitr::kable(align = 'c', head(merced_river_instream, 5))
# usethis::use_data(merced_river_instream, overwrite = TRUE)
```

```{r}
#total <- 19.2
#flows = c(75, 100, 125, 150, 175, 200, 250, 300, 350, 400, 500, 600, 700, 800, 900, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 5000, 6000)

#spawn <- function(df) {approxfun(df$flow, df$ST_spawn_wua, rule = 2)}(flows)
#fry <- function(df) {approxfun(df$flow, df$ST_fry_wua, rule = 2)}(flows)
#juv <- function(df) {approxfun(df$flow, df$ST_juv_wua, rule = 2)}(flows)



#ST_spawn_WUA <- ((spawn(steelhead_reach_1) * 9.2) + (spawn(steelhead_reach_2) * 4.4) + (spawn(steelhead_reach_3)*5.6))/total
#ST_fry_WUA <- ((fry(steelhead_reach_1)*9.2)+(fry(steelhead_reach_2)*4.4)+(fry(steelhead_reach_3)*5.6))/total
#ST_juv_WUA <- ((juv(steelhead_reach_1)*9.2)+(juv(steelhead_reach_2)*4.4)+(juv(steelhead_reach_3)*5.6))/total

#merced_ST <- data.frame(flows, ST_spawn_WUA, ST_fry_WUA, ST_juv_WUA) %>%
#  mutate(Watershed = "Merced")

#knitr::kable(align = 'c', head(merced_ST, 5))
#steelhead_reach_1
```

*...with 25 more rows.* 

### Spawning WUA 
The instream spawning habitat weighted usable areas for Fall Run Chinook Salmon in the Merced River.

#### Fall Run Chinook Salmon Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Fall Run Chinook Salmon. These area per length rates are multiplied by the total spawning reach length mapped by the SIT. 

``` {r,echo=FALSE}
merced_river_instream %>% 
    filter(!is.na(FR_spawn_wua)) %>%
    ggplot(aes(x = flow_cfs , y = FR_spawn_wua)) +
    geom_line(color = '#7570b3') +
    labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
    theme_minimal()

```

#### Steelhead Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Steelhead. These area per length rates are multiplied by the total spawning reach length mapped by the SIT. 

``` {r,echo=FALSE}
merced_river_instream %>% 
    filter(!is.na(ST_spawn_wua)) %>% 
    ggplot(aes(x = flow_cfs , y = ST_spawn_wua)) +
    geom_line(color = '#7570b3') +
    labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
    theme_minimal()

```
### Rearing WUA
The fry and juvenile instream rearing habitat weighted usable areas for Fall Run Chinook Salmon in the Merced River. 

#### Fall Run Chinook Salmon Rearing WUA Plot

The following plot shows the weighted usable rearing area in square feet per thousand feet of river for Fall Run Chinook Salmon fry and juvenile. These rates are multiplied by the total rearing reach length mapped by the SIT. 

``` {r,echo=FALSE}
merced_river_instream %>% 
  gather(Lifestage, wua, -flow_cfs, -watershed)  %>% 
  filter(!is.na(wua), Lifestage != 'FR_spawn_wua', Lifestage != 'ST_adult_wua', 
         Lifestage != 'ST_spawn_wua', Lifestage != 'ST_juv_wua', Lifestage != 
         'ST_fry_wua', Lifestage != 'ST_adult_wua') %>%
  mutate(Lifestage = ifelse(Lifestage == 'FR_fry_wua', 'Fry', 'Juvenile')) %>% 
  ggplot(aes(x = flow_cfs , y = wua, color = Lifestage)) +
  geom_line() +
  labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
  theme_minimal() + 
  scale_color_manual(values = c('#d95f02','#7570b3'))
```

#### Steelhead Rearing WUA Plot

The following plot shows the weighted usable rearing area in square feet per thousand feet of river for Steelhead fry and juvenile. These rates are multiplied by the total rearing reach length mapped by the SIT. 

``` {r,echo=FALSE}
merced_river_instream %>% 
  gather(Lifestage, wua, -flow_cfs, -watershed)  %>% 
  filter(!is.na(wua), Lifestage != 'FR_spawn_wua', Lifestage != 'ST_adult_wua', 
         Lifestage != 'ST_spawn_wua', Lifestage != 'FR_juv_wua', Lifestage != 
         'FR_fry_wua') %>%
  mutate(Lifestage = ifelse(Lifestage == 'ST_fry_wua', 'Fry', 'Juvenile')) %>% 
  ggplot(aes(x = flow_cfs , y = wua, color = Lifestage)) +
  geom_line() +
  labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
  theme_minimal() + 
  scale_color_manual(values = c('#d95f02','#7570b3'))
```

#### Steelhead Adult WUA Plot

The following plot shows the weighted usable rearing area in square feet per thousand feet of river for adult Steelhead. These rates are multiplied by the total rearing reach length mapped by the SIT. 
``` {r,echo=FALSE}
merced_river_instream %>% 
    filter(!is.na(ST_adult_wua)) %>% 
    ggplot(aes(x = flow_cfs , y = ST_spawn_wua)) +
    geom_line(color = '#7570b3') +
    labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
    theme_minimal()

```

```{r, include=FALSE}
source('data-raw/floodplain/floodplain_utils.R')
```

## Floodplain Modeling Details

**Data Source:**
[Central Valley Floodplain Evaluation and Delineation (CVFED) HEC-RAS hydraulic model](https://s3-us-west-2.amazonaws.com/cvpiahabitat-r-package/cvpia-sit-model-inputs/TO25-ST8_Tech_Memo_SJR.pdf)

`r print_model_details('Merced River', 'fr')`

## Floodplain Data

```{r, echo=FALSE}
merced_fp <- read_excel('data-raw/floodplain/CVPIA_FloodplainAreas.xlsx', sheet = 'MercedRiver') %>%
  mutate(watershed = 'Merced River')

merced_river_floodplain <- scale_fp_flow_area_partial_model(ws = 'Merced River', df = merced_fp)
knitr::kable(align = 'c', head(merced_river_floodplain, 5))
# devtools::use_data(merced_river_floodplain, overwrite = TRUE)
```

*...with 13 more rows*

## Floodplain Plot
```{r, echo = FALSE}
merced_river_floodplain %>% 
  select(FR_floodplain_acres, flow_cfs, watershed) %>%
  rename(`Fall Run Chinook and Steelhead` = FR_floodplain_acres) %>% 
  gather(Species, acres, -flow_cfs, -watershed) %>% 
  ggplot(aes(flow_cfs, acres, color = Species)) +
  geom_line() +
  theme_minimal() +
  scale_color_brewer(palette = 'Dark2') +
  labs(x = 'Flow (cfs)', y = 'Total Inundated Acres')
```

