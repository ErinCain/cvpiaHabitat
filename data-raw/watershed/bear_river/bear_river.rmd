---
title: "Bear River"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com), [Erin Cain](ecain@flowwest.com)"
date: "June 18, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(tidyverse)
library(readxl)
library(cvpiaHabitat)
```
## Future Data Improvements
None Planned

## Instream Spawning and Rearing Habitat

**Data Source:**
[SSWD 2019](https://cvpiahabitat-r-package.s3-us-west-2.amazonaws.com/cvpia-sit-model-inputs/SSWD_Bear_River_2019.pdf) (pg E3.3.3-78 to 82)

Instream spawning and rearing habitat for Fall Run Chinook Salmon and Steelhead in the Bear River are based on data from an instream flow study from the South Sutter Water District. SSWD preformed this study using River2D a 2-dimensional hydraulic and habitat model. SSWD used this model at 2 sites to find spawning and rearing availability and the FWS collected this data at a third site to come up with data for 3 separate reaches. The instream spawning and rearing habitat data was provided to us by [Mark Gard](mailto:mark_gard@fws.gov) from the U.S. Fish and Wildlife Service. We compiled it into a spreadsheet (see '~cvpiaHabitat/data-raw/bear_river/data/bear_river_new_data.csv'), combined the three reaches scaling them by length, and converted the data into sqft/1000 ft.  

### Combine Spawning and Rearing Data
The instream spawning and juvrnile rearing habitat data described above for Fall Run Chinook Salmon (FR) and Steelhead (ST) is combined for use in the DSM in the following format. Units are in square feet per 1000 feet.

```{r,echo=FALSE}
# Bear river data 
bear_raw <- read_csv('data-raw/watershed/bear_river/data/bear_river_new_data.csv',
                     skip = 1)

bear_reach_1 <- bear_raw %>% 
  filter(reach == 1) 
bear_reach_2 <- bear_raw %>% 
  filter(reach == 2) 
bear_reach_3 <- bear_raw %>% 
  filter(reach == 3) 

total <- 3.4

bear_river_instream <- bear_reach_1 %>% bind_rows(bear_reach_2, bear_reach_3) %>% 
  gather(lifestage, sq_ft, -flow_cfs, -reach_km) %>%
  group_by(lifestage, flow_cfs) %>%
  summarise(wua = sum(sq_ft/reach_km * .3048 * reach_km/ total, na.rm = TRUE)) %>%
  spread(lifestage, wua) %>% 
  select(flow_cfs, FR_spawn_wua = FR_spawn_sqft, FR_juv_wua = FR_juv_sqft, 
         FR_fry_wua = FR_fry_sqft, ST_spawn_wua = ST_spawn_sqft, 
         ST_juv_wua = ST_juv_sqft, ST_fry_wua = ST_fry_sqft) %>%
  mutate(watershed = "Bear River")

knitr::kable(align = 'c', head(bear_river_instream, 5))
#usethis::use_data(bear_river_instream, overwrite = TRUE)
```

### Spawning WUA 
The instream spawning habitat weighted usable areas for Fall Run Chinook Salmon and Steelhead in the Bear River.

#### Fall Run Chinook Salmon Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Fall Run Chinook Salmon. These area per length rates are multiplied by the total spawning reach length mapped by the SIT. 

``` {r,echo=FALSE}
bear_river_instream %>% 
    filter(!is.na(FR_spawn_wua)) %>%
    ggplot(aes(x = flow_cfs , y = FR_spawn_wua)) +
    geom_line(color= '#7570b3') +
    labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
    theme_minimal()

```

#### Steelhead Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Steelhead. These area per length rates are multiplied by the total spawning reach length mapped by the SIT. 

``` {r,echo=FALSE}
bear_river_instream %>% 
    filter(!is.na(ST_spawn_wua)) %>%
    ggplot(aes(x = flow_cfs , y = ST_spawn_wua)) +
    geom_line(color= '#7570b3') +
    labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') + 
    theme_minimal()

```

### Rearing WUA
The juvenile instream rearing habitat weighted usable areas for Fall Run Chinook Salmon in the Bear River. 

#### Fall Run Chinook Salmon Rearing WUA Plot

The following plot shows the weighted usable rearing area in square feet per thousand feet of river for Fall Run Chinook Salmon juvenile and fry. These rates are multiplied by the total rearing reach length mapped by the SIT. 
``` {r,echo=FALSE}
bear_river_instream %>% 
  gather(Lifestage, wua, -flow_cfs, -watershed)  %>% 
  filter(!is.na(wua), Lifestage != 'FR_spawn_wua', Lifestage != 'ST_spawn_wua',
         Lifestage != 'ST_fry_wua', Lifestage != 'ST_juv_wua') %>%
  mutate(Lifestage = ifelse(Lifestage == 'FR_fry_wua', 'Fry', 'Juvenile')) %>% 
  ggplot(aes(x = flow_cfs , y = wua, color = Lifestage)) +
  geom_line() +
  labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') +
  theme_minimal() + 
  scale_color_manual(values = c('#d95f02','#7570b3'))
```

#### Steelhead Rearing WUA Plot

The following plot shows the weighted usable rearing area in square feet per thousand feet of river for Steelhead fry and juvenile and fry. These rates are multiplied by the total rearing reach length mapped by the SIT. 
``` {r,echo=FALSE}
bear_river_instream %>% 
  gather(Lifestage, wua, -flow_cfs, -watershed)  %>% 
  filter(!is.na(wua), Lifestage != 'FR_spawn_wua', Lifestage != 'ST_spawn_wua',
         Lifestage != 'FR_fry_wua', Lifestage != 'FR_juv_wua') %>%
  mutate(Lifestage = ifelse(Lifestage == 'ST_fry_wua', 'Fry', 'Juvenile')) %>% 
  ggplot(aes(x = flow_cfs , y = wua, color = Lifestage)) +
  geom_line() +
  labs(x = 'Flow (cfs)', y = 'WUA (sqft/1000ft)') +
  theme_minimal() + 
  scale_color_manual(values = c('#d95f02','#7570b3'))
```
```{r, include=FALSE}
source('data-raw/floodplain/floodplain_utils.R')
```

## Floodplain Modeling Details

**Data Source:**
[Central Valley Floodplain Evaluation and Delineation (CVFED) HEC-RAS hydraulic model](https://s3-us-west-2.amazonaws.com/cvpiahabitat-r-package/cvpia-sit-model-inputs/CombinedTM_IQAR_Final-FULL-REPORT_20140206.pdf)

`r print_model_details('Bear River', 'fr')`

## Floodplain Data

```{r, echo= FALSE}
bear_fp <- read_excel('data-raw/floodplain/CVPIA_FloodplainAreas.xlsx', sheet = 'BearRiver') %>%
  mutate(watershed = 'Bear River')

threshold <- bear_fp %>% 
  filter(modeled_floodplain_area_acres == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

bear_df <- bear_fp %>% 
  filter(flow_cfs >= threshold)

bear_river_floodplain <- scale_fp_flow_area_partial_model(ws = 'Bear River', df = bear_df) 

knitr::kable(align = 'c', head(bear_river_floodplain, 5)) 
# devtools::use_data(bear_river_floodplain, overwrite = TRUE)
```


*...with 30 more rows*

## Floodplain Plot
```{r, echo = FALSE}
bear_river_floodplain %>% 
  rename(`Fall Run Chinook` = FR_floodplain_acres) %>% 
  gather(Species, acres, -flow_cfs, -watershed) %>% 
  ggplot(aes(flow_cfs, acres, color = Species)) +
  geom_line() +
  theme_minimal() +
  scale_color_brewer(palette = 'Dark2') +
  labs(x = 'Flow (cfs)', y = 'Total Inundated Acres')
```


